name: Auto-move Project on PR events

on:
  pull_request:
    types:
      - opened
      - closed

jobs:
  move-on-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Move linked issue in project
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const projectId = "PVT_kwDOCYmIm84BNk3g";
            const STATUS_FIELD_ID = "PVTSSF_lADOCYmIm84BNk3gzg8h8SE";
            const BACKLOG_OPTION_ID = "f75ad846";
            const IN_PROGRESS_OPTION_ID = "47fc9ee4";
            const QA_OPTION_ID = "51c4a8ed";
            const READY_OPTION_ID = "43cb5d2b";
            const DONE_OPTION_ID = "98236657";

            const statusOptions = {
                backlog: "BACKLOG_OPTION_ID",
                in_progress: "IN_PROGRESS_OPTION_ID",
                qa: "QA_OPTION_ID",
                ready: "READY_OPTION_ID",
                done: "DONE_OPTION_ID"
            };

            const pr = context.payload.pull_request;
            const isMerged = pr.merged;
            const action = context.payload.action;

            // Get linked issues (closes #, fixes #)
            const linkedIssues = pr.body?.match(/(close|closes|fix|fixes|resolve|resolves)\s+#\d+/gi);

            if (!linkedIssues) {
              console.log("No linked issues found.");
              return;
            }

            for (const ref of linkedIssues) {
              const issueNumber = ref.match(/#(\d+)/)[1];

              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });

              const contentId = issue.node_id;

              let status;
              if (action === "opened") status = statusOptions.qa;
              if (action === "closed" && isMerged) status = statusOptions.ready;

              if (!status) continue;

              // Add issue to project
              const addItem = await github.graphql(`
                mutation ($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(
                    input: { projectId: $projectId, contentId: $contentId }
                  ) {
                    item { id }
                  }
                }
              `, { projectId, contentId });

              const itemId = addItem.addProjectV2ItemById.item.id;

              // Update status
              await github.graphql(`
                mutation (
                  $projectId: ID!
                  $itemId: ID!
                  $fieldId: ID!
                  $optionId: String!
                ) {
                  updateProjectV2ItemFieldValue(
                    input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: { singleSelectOptionId: $optionId }
                    }
                  ) {
                    projectV2Item { id }
                  }
                }
              `, {
                projectId,
                itemId,
                fieldId: statusFieldId,
                optionId: status
              });

              console.log(`âœ… Issue #${issueNumber} moved`);
            }
